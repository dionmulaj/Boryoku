PORTS = [80, 443]

CVE_MAPPINGS = {
    "Joomla!/3.4.6": "CVE-2015-8562",
    "Joomla!/3.7.0": "CVE-2017-8917",
    "Joomla!/3.8.0": "CVE-2017-14596",
    "Joomla!/3.9.0": "CVE-2018-15880",
    "Joomla!/3.9.16": "CVE-2020-10238",
    "Joomla!/3.9.18": "CVE-2020-11890",
    "Joomla!/3.9.19": "CVE-2020-15084",
    "Joomla!/3.9.20": "CVE-2020-17489",
    "Joomla!/3.9.21": "CVE-2020-23972",
    "Joomla!/3.9.22": "CVE-2020-24589"
}

def run(host, results):
    import requests
    import re
    for port in [80, 443]:
        proto = "https" if port == 443 else "http"
        url = f"{proto}://{host}:{port}/"
        try:
            resp = requests.get(url, timeout=7, verify=False)
            x_generator = resp.headers.get("X-Generator", "N/A")
            found_version = None
            for key in CVE_MAPPINGS:
                if key in x_generator:
                    found_version = key
                    break
            if not found_version:
                meta_match = re.search(r'<meta[^>]+name=["\']generator["\'][^>]+content=["\']Joomla!?/?([0-9.]+)["\']', resp.text, re.IGNORECASE)
                if meta_match:
                    joomla_version = meta_match.group(1)
                    for key in CVE_MAPPINGS:
                        if key.endswith(joomla_version):
                            found_version = key
                            break
            cve = CVE_MAPPINGS.get(found_version)
            if cve:
                results[host].setdefault("CVE-CHECK", []).append(
                    f"Potential CVE detected: {cve} via Joomla version: {found_version}")
        except Exception:
            pass  
